# Django Cheatsheet 

This cheatsheet contains the minimal infomation to start a Django project and can be useful for quick lookups. The information provided is mainly a condensed version of the official [Django tutorial](https://docs.djangoproject.com/en/3.1/intro/).

## Table of contents
- [Create a project](#create-a-project)
- [Create an app](#create-an-app)
- [Create a a view](#create-a-view)
- [Create a database](#create-a-database)
- [Models](#models)
- [Tests](#tests)
- [Admin site](#admin-site)
- [To go further](#to-go-further)


## Create a project 
Command:
- `django-admin startproject mysite`


Will create a minimal project with the following files:

```python
mysite/
    manage.py #utility for project management
    mysite/
        __init__.py
        settings.py
        urls.py #routing confinguration
        asgi.py #entry point for asgi deployment
        wsgi.py #entry point for wsgi deployment
)
```
Setup the `TIMEZONE` variable in `settings.py`. 

Run the server with: 

- `python manage.py runserver [-port]`

## Create an app

`python manage.py startapp polls`

```python
polls/
    __init__.py
    admin.py
    apps.py
    migrations/
        __init__.py
    models.py
    tests.py
    views.py
```

## Create a view

In `polls/views.py`

```
from django.http import HttpResponse

def index(request):
    return HttpResponse("Hello, world. You're at the polls index.")
```

The routing configuration for this app needs to be manually added. Each app is modular and can define its own list of urlpatterns which will be imported in the parent module. 

Hence we first create `polls/urls.py` :

```python
from django.urls import path

from . import views

urlpatterns = [
    # ex: /polls/
    path('', views.index, name='index'),
    # ex: /polls/5/
    path('<int:question_id>/', views.detail, name='detail'),
    # ex: /polls/5/results/
    path('<int:question_id>/results/', views.results, name='results'),
    # ex: /polls/5/vote/
    path('<int:question_id>/vote/', views.vote, name='vote'),
]
```

And we can now import the `polls` routing configuration in the project urls :

```python
from django.contrib import admin
from django.urls import include, path

urlpatterns = [
    path('polls/', include('polls.urls')), #drops up to the matching part 
    path('admin/', admin.site.urls),
]
```

## Create a database

Django support various database systems (PostgreSQL, MySQL, Oracle, SQLite3). In our case we will opt for SQLite3 which fits in a single file. The database configuration requires to add the lines `settings.py`.


```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'), #path to SQLite3 db file
    }
}
```
If we choose a more traditional backend such as Postgresql, we would need to add a few more fields. 

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mydatabase',
        'USER': 'mydatabaseuser',
        'PASSWORD': 'mypassword',
        'HOST': '127.0.0.1',
        'PORT': '5432',
    }
}
```

Then run : 

- `python manage.py migrate`
 
 It will create the necessary tables for all applications in INSTALLED_APPS.

## Models

### Create a model
Add each model in `polls/models.py`. The full reference the possible fields is accessible [here](https://docs.djangoproject.com/en/3.1/ref/models/fields/#django.db.models.Field).

```python
from django.db import models

class Question(models.Model):
    question_text = models.CharField(max_length=200)
    pub_date = models.DateTimeField('date published')
    
    def __str__(self):
        return self.question_text
    

class Choice(models.Model):
    question = models.ForeignKey(Question, on_delete=models.CASCADE)
    choice_text = models.CharField(max_length=200)
    votes = models.IntegerField(default=0)

    def __str__(self):
        return self.question
    
```

Then run :
- `python manage.py makemigrations polls`

A few remarks regarding models:
- Table names are automatically generated by combining the name of the app (polls) and the lowercase name of the model â€“ question and choice. (You can override this behavior.)
- Primary keys (IDs) are added automatically. (You can override this, too.)
- By convention, Django appends "_id" to the foreign key field name. (Yes, you can override this, as well.)

Regardless of whether you define a primary key field yourself, or let Django supply one for you, each model will have a property called pk. It behaves like a normal attribute on the model, but is actually an alias for whichever attribute is the primary key field for the model. You can read and set this value, just as you would for any other attribute, and it will update the correct field in the model.


### Database API

The database API is extensively described [here](https://docs.djangoproject.com/en/3.1/topics/db/queries/).
```python
from django.utils import timezone

q = Question('Wasso wasso wassuup', timezone.now())
q.save() #write to db
Question.objects.all()
Question.objects.filter(id=1)
Question.objects.get(id=1)
Question.objects.get(pk=1) # Lookup by a primary key
q.choice_set.create(choice_text='Not much', votes=0)
```

### Templates

By default, the [template engine](https://docs.djangoproject.com/en/3.1/topics/templates/) is Django templates and the framoworks looks for files in the `templates/` folder of each app.

In `polls/views.py`:
```python
from django.shortcuts import render

from .models import Question


def index(request):
    latest_question_list = Question.objects.order_by('-pub_date')[:5]
    context = {'latest_question_list': latest_question_list}
    #context is an optional parameter
    return render(request, 'polls/index.html', context) 

def detail(request, question_id):
    question = get_object_or_404(Question, pk=question_id)
    
    #Is the same as:
    try:
        question = Question.objects.get(pk=question_id)
    except Question.DoesNotExist:
        raise Http404("Question does not exist")
    
    return render(request, 'polls/detail.html', {'question': question})
```
In templates `polls/templates/index.html`:
```
{% if latest_question_list %}
    <ul>
    {% for question in latest_question_list %}
        <li><a href="/polls/{{ question.id }}/">{{ question.question_text }}</a></li>
    {% endfor %}
    </ul>
{% else %}
    <p>No polls are available.</p>
{% endif %}
```

## Tests

```python
import datetime

from django.test import TestCase
from django.utils import timezone

from .models import Question


class QuestionModelTests(TestCase):

    def test_was_published_recently_with_future_question(self):
        """
        was_published_recently() returns False for questions whose pub_date
        is in the future.
        """
        time = timezone.now() + datetime.timedelta(days=30)
        future_question = Question(pub_date=time)
        self.assertIs(future_question.was_published_recently(), False)
def create_question(question_text, days):
    """
    Create a question with the given `question_text` and published the
    given number of `days` offset to now (negative for questions published
    in the past, positive for questions that have yet to be published).
    """
    time = timezone.now() + datetime.timedelta(days=days)
    return Question.objects.create(question_text=question_text, pub_date=time)

class QuestionIndexViewTests(TestCase):
    def test_no_questions(self):
        """
        If no questions exist, an appropriate message is displayed.
        """
        response = self.client.get(reverse('polls:index'))
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, "No polls are available.")
        self.assertQuerysetEqual(response.context['latest_question_list'], [])

    def test_past_question(self):
        """
        Questions with a pub_date in the past are displayed on the
        index page.
        """
        create_question(question_text="Past question.", days=-30)
        response = self.client.get(reverse('polls:index'))
        self.assertQuerysetEqual(
            response.context['latest_question_list'],
            ['<Question: Past question.>']
        )
```
To run the tests: 

- `python manage.py test [-polls]`

## Admin site

### Setup

Run `python manage.py createsuperuser` and enter credentials. The admin site is then accessible at URL `localhost:port/admin`.

### Models CRUD

To allow CRUD operations on a model from the admin panel, register the model in the app admin configuration file, i.e `polls/admin.py`. Check [here](https://docs.djangoproject.com/en/3.1/intro/tutorial07/) for further customization. 
```python
from django.contrib import admin
from .models import Question

admin.site.register(Question)
```

## To go further

- [Official Django documentation](https://docs.djangoproject.com/)
- [Django-REST-Framework](https://www.django-rest-framework.org/)
- [JWT for Django-REST-Framework](https://django-rest-framework-simplejwt.readthedocs.io/en/latest/index.html)
